# Umbau Status - Audio Storage System Refactoring
**Datum: 16.06.2025 23:00 | Status: Phase 2 von 4 abgeschlossen**

## üéØ **Projekt-√úberblick**

### **Grundsystem (Bestehend)**
- **Zarr v3 Backend**: High-Performance Audio-Speicherung mit Random Access auf kurze Sample-Ausschnitte
- **Dual-Codec Support**: FLAC (verlustfrei) und AAC-LC (verlustbehaftet) vollst√§ndig implementiert
- **Eigenes Index-System**: F√ºr beide Kodierungen jeweils angepasste Indizierungsmethon implrmentiert, um fast Random Access zu gew√§hrleisten
- **Performance**: AAC-Implementation ist **PRODUCTION READY** mit 50-80ms Extraktion, 1000x Speicher-Reduktion; FLAC ist ebenfalls uneingeschr√§nkt **PRODUCTION READY**
- **Architektur**: Modulares System mit codec-spezifischen Access-Modulen

### **Umbau-Ziel**
√úberarbeitung der **User-Level API** f√ºr bessere Nutzerfreundlichkeit:
- **Intelligente Parameter-Analyse** mit automatischen Codec- und Codec-Parameter-Vorschl√§gen
- **Strukturierter Workflow** √ºber `FileParameter.analyze()` 
- **Qualit√§ts-erhaltende Suggestions** (nie Verschlechterung)
- **Konflikt-Detection** mit Nutzerberatung (Nutzerberatung fragt der Nutzer √ºber die Print-Funktion der Klasse ab)
- **Einheitliche API** f√ºr beide Codecs (FLAC/AAC)

## üìã **Aktueller Implementierungsstand**

### **‚úÖ ABGESCHLOSSEN - Phase 1: Basis-Module erweitert**

#### **1. source_file.py (Komplett √ºberarbeitet)**
**Status**: ‚úÖ **FERTIG** - Kompletter Ersatz der urspr√ºnglichen Datei

**Neue Kernklassen:**
- **`QualityAnalyzer`**: Intelligente Qualit√§tsanalyse und Parameter-Vorschl√§ge
- **`ConflictAnalyzer`**: Erkennung von Import-Konflikten und Qualit√§tsproblemen
- **Enhanced `FileParameter`**: Erweitert um Target-Parameter-Management

**Neue FileParameter Properties:**
```python
# Auto-Trigger Properties (l√∂sen _analyze() aus)
file_param.target_format = "AAC_44100"  # TargetFormats|str
file_param.target_sampling_transform = "EXACTLY"  # TargetSamplingTransforming|str  
file_param.aac_bitrate = 160000  # int
file_param.flac_compression_level = 4  # int

# Analyse-Ergebnisse
file_param.quality_analysis  # dict mit Qualit√§tsbewertung
file_param.conflicts  # dict mit blocking_conflicts, quality_warnings, efficiency_warnings
file_param.can_be_imported  # bool - ber√ºcksichtigt Konflikte
```

**Smart Suggestion System:**
- **User-Tracking**: `_user_defined_params` Set verfolgt explizit gesetzte Parameter
- **Intelligente Vorschl√§ge**: Nur noch nicht user-definierte Parameter werden automatisch gesetzt
- **Qualit√§ts-Regeln**:
  - Lossy Source ‚Üí AAC mit +10...25% Bitrate
  - Lossless Source ‚Üí FLAC mit gleicher Sample-Rate
  - PCM Source ‚Üí Qualit√§ts-abh√§ngige Entscheidung

**Enhanced Print-Ausgabe (`__str__`):**
```
‚ï≠‚îÄ Audio File Analysis ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïÆ
‚îÇ File: birds_morning_song.flac (47.3 MB)             ‚îÇ
‚îÇ Container: FLAC                                      ‚îÇ 
‚îú‚îÄ Audio Stream ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Codec: FLAC (lossless)                              ‚îÇ
‚îÇ Channels: 2 (stereo)                                ‚îÇ
‚îÇ Sample Rate: 96,000 Hz                              ‚îÇ
‚îÇ Duration: 5:23.7                                     ‚îÇ
‚îú‚îÄ Recommended Import Settings ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ ‚úÖ Target: FLAC_96000 (preserve quality)            ‚îÇ
‚îÇ ‚úÖ Sampling: EXACTLY (perfect match)                ‚îÇ
‚îÇ üîß Compression: Level 4 (balanced)                  ‚îÇ
‚îÇ ‚îå‚îÄ Rationale ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ ‚îÇ Source is lossless ‚Üí keep lossless              ‚îÇ ‚îÇ
‚îÇ ‚îÇ High sample rate ‚Üí preserve for analysis        ‚îÇ ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îú‚îÄ Status ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ üü¢ Ready for import                                  ‚îÇ
‚ï∞‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïØ

Legend: ‚úÖ=User set, üîß=Auto-suggested
```

**Konflikt-Detection:**
- **Blocking Conflicts**: üö´ Verhindern Import (Sample-Rate-Inkompatibilit√§t)
- **Quality Warnings**: ‚ö†Ô∏è Qualit√§tsverlust (Lossless‚ÜíLossy, Re-Encoding)
- **Efficiency Warnings**: üí° Unn√∂tiges Aufbl√§hen (Low-Quality‚ÜíFLAC)

#### **2. audio_coding.py (Erweitert)**
**Status**: ‚úÖ **FERTIG** - Erweitert um flexible String-Konvertierung

**Neue Methoden:**
```python
# Flexibler String-Input (case-insensitive)
TargetFormats.from_string_or_enum("flac")       # ‚Üí FLAC
TargetFormats.from_string_or_enum("AAC_44100")  # ‚Üí AAC_44100  
TargetFormats.from_string_or_enum("flac44100")  # ‚Üí FLAC_44100

TargetSamplingTransforming.from_string_or_enum("exactly")           # ‚Üí EXACTLY
TargetSamplingTransforming.from_string_or_enum("resampling_48000")  # ‚Üí RESAMPLING_48000
TargetSamplingTransforming.from_string_or_enum("resample")          # ‚Üí RESAMPLING_NEAREST
```

**Unterst√ºtzte String-Formate:**
- **Case-insensitive**: `"flac"`, `"FLAC"`, `"Flac"`
- **Mit/ohne Underscore**: `"flac_44100"`, `"flac44100"`
- **Partial Matches**: `"resample"` ‚Üí `RESAMPLING_NEAREST`
- **Kurze Formen**: `"exact"` ‚Üí `EXACTLY`

### **üìã TODO - Phase 2: snd_import.py erstellen**

**Ziel**: Neue Haupt-Import-API die das `aimport.py` ersetzt

**Geplante API-Struktur:**

#### **Haupt-Import-Funktion:**
```python
def import_audio(source: str|pathlib.Path|FileParameter, 
                zarr_group: zarr.Group,
                timestamp: datetime.datetime = None,
                **kwargs) -> FileParameter:
    """
    Unified Import-Funktion:
    - Akzeptiert Dateipfad ODER vorbereiten FileParameter
    - Automatische Analyse wenn nur Pfad gegeben
    - Verwendet FileParameter.suggestions als Default
    - √úberschreibbare Parameter via kwargs
    - Gibt erweiterten FileParameter zur√ºck
    """
```

#### **Convenience Functions:**
Das muss noch genauer analysiert werden, was man hier ben√∂tigt.
```python
def quick_import(audio_file: str|pathlib.Path, 
                zarr_group: zarr.Group,
                timestamp: datetime.datetime = None) -> FileParameter:
    """Ein-Zeiler f√ºr Standard-Import mit Automatik"""

def analyze_audio(audio_file: str|pathlib.Path, 
                 target_format: str = None) -> FileParameter:
    """Nur Analyse ohne Import f√ºr Nutzer-Review"""

def batch_import(audio_files: list[str|pathlib.Path],
                zarr_group: zarr.Group,
                **kwargs) -> list[FileParameter]:
    """Batch-Import mit Progress-Feedback"""
```

#### **Workflow-Integration:**
```python
# Automatischer Workflow (f√ºr einfache F√§lle)
result = quick_import("audio.wav", zarr_group)

# Analyse-gesteuerter Workflow (f√ºr Kontrolle)
file_param = analyze_audio("audio.wav")
print(file_param)  # Review suggestions
file_param.aac_bitrate = 192000  # Override if needed
result = import_audio(file_param, zarr_group)

# Direkter Workflow mit Overrides
result = import_audio("audio.wav", zarr_group, 
                     target_format="AAC_44100", 
                     aac_bitrate=160000)
```

### **üìã TODO - Phase 3: Integration & Testing**

#### **__init__.py Update:**
```python
# Hauptfunktionen direkt verf√ºgbar machen
from .snd_import import (
    import_audio, quick_import, analyze_audio, batch_import
)
from .source_file import FileParameter
from .audio_coding import TargetFormats, TargetSamplingTransforming

__all__ = [
    'import_audio', 'quick_import', 'analyze_audio', 'batch_import',
    'FileParameter', 'TargetFormats', 'TargetSamplingTransforming'
]
```

#### **Legacy Compatibility (Optional):**
Legacy ist im derzeitigen Entwicklungsstand nicht erforderlich.

### **üìã TODO - Phase 4: Validierung & Dokumentation**

- **Test-Suite erweitern** f√ºr neue FileParameter-Features
- **Performance-Validation** der neuen API
- **Dokumentation aktualisieren** mit neuen Workflows
- **Beispiel-Scripts** f√ºr verschiedene Use-Cases

## üéØ **Design-Prinzipien & Anforderungen**

### **Nutzer-Workflow Zielvorstellung:**
```python
# 1. Analyse-Phase
file_parameter = FileParameter("audio.wav")
print(file_parameter)  # Zeigt Streams + intelligente Vorschl√§ge

# 2. Optional: Parameter anpassen  
file_parameter.target_format = "AAC_44100"  # Auto-trigger re-analysis
file_parameter.aac_bitrate = 192000         # Auto-trigger re-analysis

# 3. Import wenn ready
if file_parameter.can_be_imported:
    import_audio(file_parameter, zarr_group, timestamp)
else:
    print("Konflikte gefunden - siehe Vorschl√§ge oben")
```

### **Qualit√§ts-Erhaltungs-Regeln:**
1. **Niemals Qualit√§t verschlechtern** nicht, ohne explizite Nutzer-Entscheidung
2. **Lossy Sources**: AAC mit h√∂herer Bitrate (+10-30%) vorschlagen
3. **Lossless Sources**: FLAC mit gleicher Sample-Rate bevorzugen
4. **Bit-Depth**: Nicht unn√∂tig aufbl√§hen (24bit‚Üí32bit vermeiden)
5. **Sample-Rate**: FLAC bis rund 655kHz (Maximalwert im Header beschr√§nkt), dar√ºber Reinterpretation vorschlagen
6. **Lossles zu Lossy vom Nutzer gew√ºnscht**: Schlage bei √ºber 48kHz bis 96KHz Resampling auf 48kHz vor. Dar√ºber gehen wir von Ultraschallaufnahmen aus: schlage Reinterpretation auf 24KHz vor, damit die Filter nicht zu viel vom oberen Frequentband entfernen.

### **Konflikt-Handling:**
- **Auto-Detection**: Inkompatible Parameter automatisch erkennen
- **User-Guidance**: Konkrete L√∂sungsvorschl√§ge in print()-Ausgabe
- **Blocking**: `can_be_imported=False` bei kritischen Konflikten
- **Warnings**: Qualit√§ts-/Effizienz-Warnungen ohne Import-Blockierung

### **String/Enum Flexibilit√§t:**
- **Case-insensitive**: Alle Gro√ü-/Kleinschreibungen akzeptieren
- **Flexible Formate**: Mit/ohne Unterstriche, Partial Matches
- **Hilfreiche Fehler**: Verf√ºgbare Optionen bei ung√ºltiger Eingabe anzeigen

## üîß **Technische Integration**

### **Bestehende Module (unver√§ndert):**
- **`flac_access.py`**: ‚úÖ Produktionsreif, keine √Ñnderungen n√∂tig
- **`aac_access.py`**: ‚úÖ Produktionsreif, keine √Ñnderungen n√∂tig  
- **`flac_index_backend.py`**: ‚úÖ Optimiert, keine √Ñnderungen n√∂tig
- **`aac_index_backend.py`**: ‚úÖ Optimiert, keine √Ñnderungen n√∂tig
- **`config.py`**: ‚úÖ AAC-Parameter bereits integriert
- **`utils.py`**: ‚úÖ Alle ben√∂tigten Helpers vorhanden

### **Integration-Points:**
```python
# snd_import.py wird delegieren an:
if target_format.code == 'flac':
    from .flac_access import import_flac_to_zarr
    result = import_flac_to_zarr(zarr_group, audio_file, source_params, ...)
    
elif target_format.code == 'aac':
    from .aac_access import import_aac_to_zarr  
    result = import_aac_to_zarr(zarr_group, audio_file, source_params, ...)
```

### **Parameter-Mapping:**
```python
def _map_file_parameter_to_import_params(file_param: FileParameter) -> dict:
    """Convert FileParameter to codec-specific import parameters"""
    base_params = {
        'audio_file': file_param.base_parameter.file,
        'source_params': _extract_source_params(file_param),
        'temp_dir': '/tmp'
    }
    
    if file_param.target_format.code == 'flac':
        base_params['flac_compression_level'] = file_param.flac_compression_level
    elif file_param.target_format.code == 'aac':
        base_params['aac_bitrate'] = file_param.aac_bitrate
    
    return base_params
```

## üö® **Bekannte Implementierungs-Details**

### **FileParameter._analyze() Trigger-System:**
- **Auto-Trigger**: Jede Property-√Ñnderung l√∂st `_analyze()` aus
- **User-Tracking**: `_user_defined_params` Set verhindert Override von User-Choices
- **Re-Suggestion**: Nur nicht-user-definierte Parameter werden neu vorgeschlagen

### **Conflict Detection Logic:**
```python
# ConflictAnalyzer.analyze_conflicts() gibt zur√ºck:
{
    'blocking_conflicts': [],     # Import-verhindernde Probleme
    'quality_warnings': [],      # Qualit√§tsverlust-Warnungen  
    'efficiency_warnings': []    # Aufbl√§h-Warnungen
}
```

### **Print-Ausgabe Formatierung:**
- **Unicode Box-Drawing**: ‚ï≠‚îÄ‚ïÆ‚îú‚îÄ‚î§‚ï∞‚îÄ‚ïØ f√ºr saubere Darstellung
- **Status-Icons**: ‚úÖüîßüö´‚ö†Ô∏èüí° f√ºr schnelle visuelle Erfassung
- **Text-Wrapping**: `_wrap_text()` f√ºr lange Konflik-Beschreibungen
- **Legend**: Erkl√§rung der Icons am Ende der Ausgabe

## üìÇ **Datei-Status √úbersicht**

```
Projekt-Root/
‚îú‚îÄ‚îÄ source_file.py          ‚úÖ ERSETZT - Komplett neue Version implementiert
‚îú‚îÄ‚îÄ audio_coding.py         ‚úÖ ERWEITERT - from_string_or_enum() hinzugef√ºgt
‚îú‚îÄ‚îÄ snd_import.py           üìã TODO - Neue Haupt-API erstellen
‚îú‚îÄ‚îÄ __init__.py             üìã TODO - Imports f√ºr neue API aktualisieren
‚îú‚îÄ‚îÄ aimport.py              üóëÔ∏è ERSETZEN - Wird durch snd_import.py ersetzt
‚îú‚îÄ‚îÄ config.py               ‚úÖ FERTIG - AAC-Parameter bereits vorhanden
‚îú‚îÄ‚îÄ flac_access.py          ‚úÖ FERTIG - Keine √Ñnderungen n√∂tig
‚îú‚îÄ‚îÄ aac_access.py           ‚úÖ FERTIG - Keine √Ñnderungen n√∂tig
‚îú‚îÄ‚îÄ flac_index_backend.py   ‚úÖ FERTIG - Keine √Ñnderungen n√∂tig
‚îú‚îÄ‚îÄ aac_index_backend.py    ‚úÖ FERTIG - Keine √Ñnderungen n√∂tig
‚îú‚îÄ‚îÄ utils.py                ‚úÖ FERTIG - Alle Helper vorhanden
‚îú‚îÄ‚îÄ exceptions.py           ‚úÖ FERTIG - Keine √Ñnderungen n√∂tig
‚îú‚îÄ‚îÄ packagetypes.py         ‚úÖ FERTIG - Keine √Ñnderungen n√∂tig
‚îî‚îÄ‚îÄ logsetup.py             ‚úÖ FERTIG - Keine √Ñnderungen n√∂tig
```

## üéØ **N√§chste konkrete Schritte**

### **Unmittelbar (n√§chster Chat):**
1. **`snd_import.py` erstellen** mit den geplanten Haupt-Funktionen
2. **Integration testen** - FileParameter ‚Üí Import-Pipeline
3. **Parameter-Mapping** implementieren (FileParameter ‚Üí Codec-Module)

### **Validierung:**
1. **Test-Script** f√ºr den kompletten Workflow schreiben
2. **Edge-Cases** testen (Konflikte, ung√ºltige Parameter)
3. **Performance** der neuen API validieren

### **Finalisierung:**
1. **`__init__.py`** f√ºr neue API aktualisieren
2. **Legacy-Wrapper** optional erstellen
3. **Dokumentation** mit Beispielen aktualisieren

## üí° **Design-Entscheidungen Getroffen**

1. **Auto-Trigger**: Property-√Ñnderungen triggern sofort Re-Analyse (vs. expliziter analyze()-Aufruf)
2. **Direct Parameter Storage**: Suggestions werden direkt als Parameter gespeichert (vs. separate suggestion-Properties)
3. **Smart Override**: User-definierte Parameter werden nie √ºberschrieben
4. **Complete File Replacement**: Komplette source_file.py ersetzt (vs. inkrementelle Patches)
5. **Unicode Box Output**: Sch√∂ne Terminal-Ausgabe mit Box-Drawing-Zeichen
6. **Three-Tier Conflicts**: blocking/quality/efficiency Kategorien f√ºr Nutzer-Guidance

**Projekt ist bereit f√ºr Phase 2: snd_import.py Implementation!**